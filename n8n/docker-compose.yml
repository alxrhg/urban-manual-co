version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: urban-manual-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Basic Configuration
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}

      # Security
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}

      # Execution
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_TIMEOUT=${EXECUTIONS_TIMEOUT:-300}
      - EXECUTIONS_TIMEOUT_MAX=${EXECUTIONS_TIMEOUT_MAX:-600}

      # Timezone (set to your local timezone)
      - GENERIC_TIMEZONE=${TIMEZONE:-America/New_York}
      - TZ=${TIMEZONE:-America/New_York}

      # Database (using SQLite for simplicity, can upgrade to PostgreSQL)
      - DB_TYPE=sqlite
      - DB_SQLITE_VACUUM_ON_STARTUP=true

      # External Service Connections
      - NODE_FUNCTION_ALLOW_EXTERNAL=${NODE_FUNCTION_ALLOW_EXTERNAL:-*}
      - NODE_FUNCTION_ALLOW_BUILTIN=${NODE_FUNCTION_ALLOW_BUILTIN:-*}

      # Your Urban Manual Services
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - POSTGRES_URL=${POSTGRES_URL}
      - ML_SERVICE_URL=${ML_SERVICE_URL:-http://host.docker.internal:8000}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY}
      - GOOGLE_API_KEY=${NEXT_PUBLIC_GOOGLE_API_KEY}
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}

    volumes:
      # Persist workflow data and credentials
      - n8n_data:/home/node/.n8n

      # Optional: Import pre-built workflows
      - ./workflows:/workflows:ro

      # Optional: Custom nodes
      - ./custom-nodes:/home/node/.n8n/custom:ro

    networks:
      - urban-manual-network

    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Allow access to host network for ML service
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  n8n_data:
    driver: local

networks:
  urban-manual-network:
    external: true
    # Note: This network is shared with ml-service
    # If it doesn't exist, run: docker network create urban-manual-network
