name: Vercel Deployment Check

on:
  deployment_status:
    # Triggered when Vercel completes a deployment
  workflow_dispatch:

jobs:
  check-deployment:
    name: Verify Deployment Health
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Get deployment URL
        id: deployment-url
        run: |
          if [ "${{ github.event_name }}" = "deployment_status" ]; then
            # Extract URL from deployment event
            DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "Using deployment URL: $DEPLOYMENT_URL"
          else
            # Use configured URL for manual runs
            DEPLOYMENT_URL="${{ secrets.VERCEL_URL || 'urban-manual.vercel.app' }}"
            echo "url=https://$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "Using configured URL: https://$DEPLOYMENT_URL"
          fi

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for deployment to be fully ready..."
          sleep 30

      - name: Run health check
        id: health-check
        run: |
          DEPLOYMENT_URL="${{ steps.deployment-url.outputs.url }}"
          echo "Checking health at: $DEPLOYMENT_URL/api/health"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOYMENT_URL/api/health" || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed!"
              echo "$BODY" | jq '.' || echo "$BODY"
              echo "status=passed" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES failed (HTTP $HTTP_CODE)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 20
              fi
            fi
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Run comprehensive deployment check
        if: steps.health-check.outputs.status == 'passed'
        run: |
          DEPLOYMENT_URL="${{ steps.deployment-url.outputs.url }}"
          echo "Running comprehensive deployment check..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOYMENT_URL/api/deployment-check")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ All deployment checks passed!"
            
            # Display detailed results
            echo ""
            echo "## Deployment Check Results"
            echo ""
            echo "$BODY" | jq -r '.results | to_entries[] | "- **\(.key)**: \(.value.status) - \(.value.message)"' || true
            
            # Check if all checks passed
            ALL_PASSED=$(echo "$BODY" | jq -r '.status == "passed"')
            if [ "$ALL_PASSED" != "true" ]; then
              echo "❌ Some checks failed"
              exit 1
            fi
          else
            echo "❌ Deployment check failed with HTTP $HTTP_CODE"
            echo "$BODY" | jq -r '.message // .error // "Unknown error"' || echo "$BODY"
            exit 1
          fi

      - name: Create deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.health-check.outputs.status }}' === 'passed' ? 'success' : 'failure';
            const description = status === 'success' 
              ? 'All deployment checks passed'
              : 'Deployment health check failed';
            
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ github.event.deployment.id || '0' }},
              state: status,
              description: description,
              environment_url: '${{ steps.deployment-url.outputs.url }}'
            });

