name: ML Service CD

on:
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Container tag to deploy'
        default: latest
        required: true
  push:
    paths:
      - 'deploy/k8s/**'
      - '.github/workflows/ml-service-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      IMAGE: ghcr.io/${{ github.repository_owner }}/urban-manual-ml-service:${{ github.event.inputs['image-tag'] || 'latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -z "$KUBE_CONFIG_B64" ]; then
            echo "KUBE_CONFIG secret is required" >&2
            exit 1
          fi
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG_B64" | base64 --decode > ~/.kube/config

      - name: Apply manifests
        run: |
          kubectl apply -f deploy/k8s
          kubectl set image deployment/ml-service ml-service=$IMAGE -n ml-service
          kubectl rollout status deployment/ml-service -n ml-service --timeout=120s
