name: Deployment Check

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true

      - name: Build project
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key' }}
          NEXT_PUBLIC_GOOGLE_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_API_KEY || 'placeholder-key' }}

  deployment-health-check:
    name: Deployment Health Check
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
      - name: Wait for Vercel deployment
        run: |
          echo "Waiting for Vercel to deploy..."
          sleep 60
          
      - name: Get Vercel deployment URL
        id: vercel-url
        run: |
          # Try to get deployment URL from Vercel API
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            DEPLOYMENT_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=1" \
              | jq -r '.deployments[0].url' 2>/dev/null || echo "")
            
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "url=https://$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "Found deployment: https://$DEPLOYMENT_URL"
            else
              echo "url=${{ secrets.VERCEL_URL || 'urban-manual.vercel.app' }}" >> $GITHUB_OUTPUT
              echo "Using fallback URL: ${{ secrets.VERCEL_URL || 'urban-manual.vercel.app' }}"
            fi
          else
            echo "url=${{ secrets.VERCEL_URL || 'urban-manual.vercel.app' }}" >> $GITHUB_OUTPUT
            echo "Using configured URL: ${{ secrets.VERCEL_URL || 'urban-manual.vercel.app' }}"
          fi

      - name: Run deployment health check
        id: health-check
        run: |
          DEPLOYMENT_URL="${{ steps.vercel-url.outputs.url }}"
          echo "Checking deployment health at: $DEPLOYMENT_URL"
          
          # Wait a bit more for deployment to be fully ready
          sleep 10
          
          # Run health check with retries
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOYMENT_URL/api/health" || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed!"
              echo "$BODY" | jq '.' || echo "$BODY"
              echo "status=passed" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "❌ Health check failed with status $HTTP_CODE"
              echo "$BODY"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Retrying in 15 seconds..."
                sleep 15
              fi
            fi
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Run comprehensive deployment check
        if: steps.health-check.outputs.status == 'passed'
        run: |
          DEPLOYMENT_URL="${{ steps.vercel-url.outputs.url }}"
          echo "Running comprehensive deployment check..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOYMENT_URL/api/deployment-check" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ All deployment checks passed!"
            
            # Extract and display check results
            echo "$BODY" | jq -r '.results | to_entries[] | "\(.key): \(.value.status) - \(.value.message)"' || true
          else
            echo "❌ Deployment check failed with status $HTTP_CODE"
            echo "$BODY" | jq -r '.message // .error // "Unknown error"' || echo "$BODY"
            exit 1
          fi

      - name: Comment on PR (if applicable)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Deployment health check failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

