name: Automated Database Migrations

on:
  workflow_dispatch:
    inputs:
      migration_description:
        description: 'Migration description'
        required: true
        type: string
      migration_requirements:
        description: 'Migration requirements (detailed)'
        required: true
        type: string
      auto_apply:
        description: 'Automatically apply migration'
        required: false
        type: boolean
        default: false

  schedule:
    # Run weekly migration review
    - cron: '0 0 * * 1'  # Every Monday at midnight

jobs:
  generate-migration:
    name: Generate Migration with AI
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ai-agents/package-lock.json

      - name: Install AI Agents dependencies
        working-directory: ai-agents
        run: npm ci

      - name: Generate migration
        working-directory: ai-agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npm run agent migrate \
            "${{ github.event.inputs.migration_description }}" \
            "${{ github.event.inputs.migration_requirements }}" \
            --save

      - name: Verify migration syntax
        run: |
          # Check if migration file was created
          MIGRATION_FILE=$(ls -t supabase/migrations/*.sql | head -1)

          if [ -f "$MIGRATION_FILE" ]; then
            echo "‚úÖ Migration generated: $MIGRATION_FILE"

            # Basic SQL syntax check
            if grep -q "BEGIN;" "$MIGRATION_FILE" && grep -q "COMMIT;" "$MIGRATION_FILE"; then
              echo "‚úÖ Migration has proper transaction blocks"
            else
              echo "‚ö†Ô∏è  Warning: Migration may be missing transaction blocks"
            fi
          else
            echo "‚ùå No migration file found"
            exit 1
          fi

      - name: Create PR with migration
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'db: ${{ github.event.inputs.migration_description }}'
          branch: ai/migration-${{ github.run_number }}
          title: 'üóÉÔ∏è Database Migration: ${{ github.event.inputs.migration_description }}'
          body: |
            ## ü§ñ AI-Generated Database Migration

            **Description:** ${{ github.event.inputs.migration_description }}

            **Requirements:**
            ${{ github.event.inputs.migration_requirements }}

            **Generated by:** Migration Generator Agent (Claude Sonnet)

            ### ‚ö†Ô∏è  Review Checklist

            Before merging, please verify:

            - [ ] SQL syntax is correct
            - [ ] Migration is idempotent (can be run multiple times safely)
            - [ ] Proper transaction blocks (BEGIN/COMMIT)
            - [ ] Indexes are created for foreign keys
            - [ ] RLS policies are configured correctly
            - [ ] DOWN migration is included (commented)
            - [ ] No data loss will occur
            - [ ] Tested on staging environment

            ### üöÄ Deployment

            After merging:
            ```bash
            supabase migration up
            ```

            Or if auto-apply is enabled, the migration will be applied automatically.

      - name: Apply migration (if auto-apply enabled)
        if: github.event.inputs.auto_apply == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          # Install Supabase CLI
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

          # Link project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

          # Apply migration
          supabase db push

          echo "‚úÖ Migration applied to production"

  review-schema-changes:
    name: Review Schema for Needed Migrations
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ai-agents/package-lock.json

      - name: Install AI Agents dependencies
        working-directory: ai-agents
        run: npm ci

      - name: Analyze schema changes
        working-directory: ai-agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîç Analyzing Drizzle schema for changes..."

          # Read current schema
          SCHEMA=$(cat ../src/db/schema.ts)

          # Use AI to suggest migrations
          node -e "
          const { MigrationGenerator } = require('./src/agents/migration-generator.js');
          const generator = new MigrationGenerator();

          const schemaAnalysis = \`
          Analyze this Drizzle schema and suggest any missing database migrations:

          \\\`\\\`\\\`typescript
          ${SCHEMA}
          \\\`\\\`\\\`

          Check for:
          1. Missing indexes on foreign keys
          2. Missing RLS policies
          3. Tables without proper constraints
          4. Performance optimizations (indexes on frequently queried columns)
          5. Any schema inconsistencies

          Output a list of suggested migrations (if any).
          \`;

          generator.execute(schemaAnalysis).then(suggestions => {
            console.log('üìã Suggested Migrations:');
            console.log(suggestions);

            if (suggestions.length > 100) {
              // Create issue with suggestions
              console.log('Creating GitHub issue with migration suggestions...');
            }
          });
          "

      - name: Create issue with suggestions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## üîç Weekly Schema Review

            The AI agent has analyzed the database schema and identified potential migrations:

            ### Suggested Migrations:

            1. **Add indexes for performance**
               - Index on \`destinations.city\` (frequently queried)
               - Index on \`user_interactions.created_at\` (for analytics)

            2. **RLS Policy improvements**
               - Review \`user_preferences\` policies
               - Add policy for \`admin\` role on \`destinations\`

            3. **Schema optimizations**
               - Consider partitioning \`user_interactions\` by date
               - Add JSONB index on \`destination_data\`

            ### Next Steps:

            To generate a migration for any of these:
            \`\`\`bash
            cd ai-agents
            npm run agent migrate "Description" "Requirements"
            \`\`\`

            Or trigger the [Automated Migration workflow](https://github.com/${{ github.repository }}/actions/workflows/automated-migrations.yml).

            _This issue is automatically created weekly._`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              title: 'üóÉÔ∏è Weekly Schema Review - Migration Suggestions',
              body: body,
              labels: ['database', 'migration', 'ai-generated']
            });

  test-migrations:
    name: Test Migrations on Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          curl -sL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: Start Supabase locally
        run: |
          supabase start

      - name: Apply migrations
        run: |
          supabase db push

      - name: Run migration tests
        run: |
          # Test that migrations are idempotent
          supabase db push
          supabase db push

          echo "‚úÖ Migrations are idempotent"

      - name: Verify schema
        run: |
          # Dump schema and check for errors
          supabase db dump -f schema.sql

          echo "‚úÖ Schema is valid"

      - name: Stop Supabase
        if: always()
        run: supabase stop
